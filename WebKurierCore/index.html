<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –∏ –∞–≥–µ–Ω—Ç-–≤–µ—Ä—Å—Ç–∞–ª—å—â–∏–∫</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    #terminal-container {
      max-width: 600px;
      margin: 40px auto 20px auto;
      background: #222;
      color: #eee;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      padding: 24px 24px 16px 24px;
    }
    #terminal-output {
      width: 100%;
      height: 280px;
      background: #111;
      color: #cfcfcf;
      border: none;
      border-radius: 6px;
      padding: 12px;
      font-family: 'Fira Mono', 'Consolas', monospace;
      font-size: 15px;
      resize: none;
      margin-bottom: 12px;
      box-sizing: border-box;
    }
    #terminal-input {
      width: 100%;
      padding: 8px 12px;
      border-radius: 4px;
      border: none;
      background: #333;
      color: #fff;
      font-size: 15px;
      font-family: inherit;
      box-sizing: border-box;
      outline: none;
      margin-bottom: 8px;
    }
    #dropbox-controls {
      margin-bottom: 8px;
    }
    #dropbox-controls button {
      margin-right: 8px;
      margin-bottom: 4px;
      padding: 6px 14px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #3b82f6;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    #dropbox-controls button:hover {
      background: #2563eb;
    }
    /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∞–≥–µ–Ω—Ç–∞-–≤–µ—Ä—Å—Ç–∞–ª—å—â–∏–∫–∞ --- */
    #preview-controls {
      position: fixed;
      bottom: 10px;
      left: 10px;
      z-index: 9999;
      background: #fff;
      padding: 12px;
      border: 1px solid #ccc;
      font-family: sans-serif;
      max-width: 450px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    #preview-controls select,
    #preview-controls textarea,
    #preview-controls input[type="file"] {
      font-size: 15px;
      margin-bottom: 4px;
    }
    #preview-controls button {
      margin-right: 4px;
      margin-bottom: 4px;
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #2563eb;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    #preview-controls button:hover {
      background: #1e40af;
    }
    #preview-controls textarea {
      resize: vertical;
      min-height: 38px;
      max-height: 80px;
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
      margin-bottom: 4px;
    }
  </style>
  <!-- üîß –ê–ì–ï–ù–¢ –í–ï–†–°–¢–ê–õ–¨–©–ò–ö -->
  <script type="module">
    import { LayoutAgent } from './engine/agents/layout-agent/layout-agent.js';
    import { LayoutUI } from './engine/agents/layout-agent/layout-ui.js';

    LayoutUI.init(); // —Å–æ–∑–¥–∞—ë–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞

    window.handleLayoutCommand = (cmd, args, output) => {
      LayoutAgent.handleCommand(cmd, args, output);
    };
  </script>
</head>
<body>
  <div id="terminal-container">
    <div id="dropbox-controls"></div>
    <textarea id="terminal-output" readonly></textarea>
    <input id="terminal-input" autocomplete="off" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏ –Ω–∞–∂–º–∏—Ç–µ Enter...">
  </div>
  <script type="module">
    // === terminal.js ===
    // –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–º–∞–Ω–¥ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Dropbox-–∞–≥–µ–Ω—Ç–æ–º

    import { dropboxAgent } from './engine/dropbox-agent.js';

    let balance = 0;
    const autoLoadHistory = true;

    function getBalance() { return balance; }
    function setBalance(val) { balance = val; }
    function addCoins(n) { setBalance(getBalance() + n); }
    function resetCoins() { setBalance(0); }

    function printToTerminal(message, isHtml = false) {
      const output = document.getElementById('terminal-output');
      if (isHtml) {
        output.value += message + '\n';
      } else {
        output.value += escapeHtml(message) + '\n';
      }
      output.scrollTop = output.scrollHeight;
    }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.innerText = text;
      return div.innerHTML;
    }

    async function loadCopilotHistory() {
      try {
        const result = await dropboxAgent.load('dropbox-history.json');
        if (!result) {
          printToTerminal('‚ùå –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
          return;
        }
        if (typeof result === 'object' && result.text) {
          const text = await result.text();
          printToTerminal(`üìú –ò—Å—Ç–æ—Ä–∏—è Copilot:\n${text}`);
        } else {
          printToTerminal(`üìú –ò—Å—Ç–æ—Ä–∏—è Copilot:\n${result}`);
        }
      } catch (err) {
        printToTerminal(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${err.message || err}`);
      }
    }

    async function handleCommand(event) {
      if (event.key !== 'Enter') return;
      const input = event.target;
      const command = input.value.trim();
      input.value = '';

      if (!command) {
        input.focus();
        return;
      }

      printToTerminal('> ' + command);

      switch (true) {
        case command.startsWith('/add '): {
          const parts = command.split(' ');
          const amount = parseFloat(parts[1]);
          if (isNaN(amount)) {
            printToTerminal('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã.');
          } else {
            addCoins(amount);
            printToTerminal(`üí∞ –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ ${amount}. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${getBalance()}.`);
          }
          break;
        }
        case command.startsWith('/save'): {
          const parts = command.split(' ');
          const filename = parts[1] || 'webcoin.txt';
          const data = `–ë–∞–ª–∞–Ω—Å: ${getBalance()}`;
          try {
            await dropboxAgent.save(filename, data);
            printToTerminal(`‚úÖ –ë–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª "${filename}".`);
          } catch (err) {
            printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message || err}`);
          }
          break;
        }
        case command.startsWith('/load'): {
          const parts = command.split(' ');
          const filename = parts[1] || 'webcoin.txt';
          try {
            const result = await dropboxAgent.load(filename);
            if (!result) {
              printToTerminal(`‚ùå –§–∞–π–ª "${filename}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
            } else if (typeof result === 'object' && result.text) {
              const text = await result.text();
              printToTerminal(`üì• –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ "${filename}":\n${text}`);
            } else {
              printToTerminal(`üì• –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ "${filename}":\n${result}`);
            }
          } catch (err) {
            printToTerminal(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message || err}`);
          }
          break;
        }
        case command === '/list': {
          try {
            const files = await dropboxAgent.list();
            if (!files || !files.length) {
              printToTerminal('üìÇ –ü–∞–ø–∫–∞ Dropbox –ø—É—Å—Ç–∞.');
            } else {
              const fileList = files.map(f => '‚Ä¢ ' + (typeof f === 'string' ? f : f.name)).join('\n');
              printToTerminal(`üìÅ –§–∞–π–ª—ã –≤ Dropbox:\n${fileList}`);
            }
          } catch (err) {
            printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞: ${err.message || err}`);
          }
          break;
        }
        case command === '/history': {
          await loadCopilotHistory();
          break;
        }
        case command === '/balance': {
          printToTerminal(`üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${getBalance()}`);
          break;
        }
        case command === '/reset': {
          resetCoins();
          printToTerminal('üîÑ –ë–∞–ª–∞–Ω—Å —Å–±—Ä–æ—à–µ–Ω.');
          break;
        }
        case command === '/ping': {
          printToTerminal('üèì Pong!');
          break;
        }
        case command === 'help': {
          printToTerminal(
`üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/add N         ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å—É–º–º—É –∫ –±–∞–ª–∞–Ω—Å—É
/save [–∏–º—è]    ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é webcoin.txt)
/load [–∏–º—è]    ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é webcoin.txt)
/list          ‚Äî —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ Dropbox
/history       ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é Copilot
/balance       ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å
/reset         ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å
/ping          ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏
help           ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É`
          );
          break;
        }
        default: {
          printToTerminal('‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ help –¥–ª—è —Å–ø–∏—Å–∫–∞.');
          break;
        }
      }
      input.focus();
    }

    const terminalInput = document.getElementById('terminal-input');
    terminalInput.addEventListener('keydown', handleCommand);

    function addDropboxButtons() {
      const controls = document.getElementById('dropbox-controls');
      if (!controls) return;

      if (!document.getElementById('save-btn')) {
        const saveBtn = document.createElement('button');
        saveBtn.id = 'save-btn';
        saveBtn.textContent = 'üì§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        saveBtn.onclick = async function() {
          const name = prompt('–ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', 'webcoin.txt');
          if (name) {
            const content = `–ë–∞–ª–∞–Ω—Å: ${getBalance()}`;
            try {
              await dropboxAgent.save(name, content);
              printToTerminal(`‚úÖ –§–∞–π–ª "${name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Dropbox.`);
            } catch (err) {
              printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message || err}`);
            }
          }
          terminalInput.focus();
        };
        controls.appendChild(saveBtn);
      }

      if (!document.getElementById('load-btn')) {
        const loadBtn = document.createElement('button');
        loadBtn.id = 'load-btn';
        loadBtn.textContent = 'üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å';
        loadBtn.onclick = async function() {
          const name = prompt('–ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:', 'webcoin.txt');
          if (name) {
            try {
              const result = await dropboxAgent.load(name);
              if (result && result.text) {
                const text = await result.text();
                printToTerminal(`üì• –§–∞–π–ª "${name}" –∑–∞–≥—Ä—É–∂–µ–Ω:\n${text}`);
              } else if (result) {
                printToTerminal(`üì• –§–∞–π–ª "${name}" –∑–∞–≥—Ä—É–∂–µ–Ω:\n${result}`);
              } else {
                printToTerminal(`‚ùå –§–∞–π–ª "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
              }
            } catch (err) {
              printToTerminal(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message || err}`);
            }
          }
          terminalInput.focus();
        };
        controls.appendChild(loadBtn);
      }

      if (!document.getElementById('list-btn')) {
        const listBtn = document.createElement('button');
        listBtn.id = 'list-btn';
        listBtn.textContent = 'üìÅ –§–∞–π–ª—ã';
        listBtn.onclick = async function() {
          try {
            const files = await dropboxAgent.list();
            if (!files || !files.length) {
              printToTerminal('üìÇ –ü–∞–ø–∫–∞ Dropbox –ø—É—Å—Ç–∞.');
            } else {
              const fileList = files.map(f => '‚Ä¢ ' + (typeof f === 'string' ? f : f.name)).join('\n');
              printToTerminal(`üìÅ –§–∞–π–ª—ã –≤ Dropbox:\n${fileList}`);
            }
          } catch (err) {
            printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞: ${err.message || err}`);
          }
          terminalInput.focus();
        };
        controls.appendChild(listBtn);
      }

      if (!document.getElementById('copilot-history-btn')) {
        const btn = document.createElement('button');
        btn.id = 'copilot-history-btn';
        btn.textContent = 'üìú –ò—Å—Ç–æ—Ä–∏—è Copilot';
        btn.onclick = loadCopilotHistory;
        controls.appendChild(btn);
      }
    }
    addDropboxButtons();

    if (autoLoadHistory) {
      loadCopilotHistory();
    }

    printToTerminal('üñ•Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –≥–æ—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.');
    terminalInput.focus();
  </script>

  <!-- üì¶ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≥–µ–Ω—Ç–∞-–≤–µ—Ä—Å—Ç–∞–ª—å—â–∏–∫–∞ -->
  <div id="preview-controls">
    <div style="margin-bottom: 6px;">
      <select id="template-select" style="width: 100%;">
        <option value="">üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–±–ª–æ–Ω–æ–≤...</option>
      </select>
      <button onclick="handleTemplateBuild()">üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
    <div style="margin-bottom: 6px;">
      <input type="file" id="upload-html" accept=".html" />
      <button onclick="loadCustomHTML()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å HTML</button>
    </div>
    <div style="margin-bottom: 6px;">
      <textarea id="ai-description" placeholder="üß† –û–ø–∏—à–∏, —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ª–µ–Ω–¥–∏–Ω–≥ —Å –∫–Ω–æ–ø–∫–æ–π)" rows="2" style="width: 100%;"></textarea>
      <button onclick="generateFromAI()">ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é</button>
    </div>
    <div style="margin-bottom: 6px;">
      <button onclick="if (window.lastGeneratedHTML?.length) LayoutUI.show(window.lastGeneratedHTML); else alert('HTML –ø—É—Å—Ç!')">üîç –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</button>
      <button onclick="LayoutUI.hide()">‚ùå –°–∫—Ä—ã—Ç—å</button>
      <button onclick="downloadHTML()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="exportToZip()">üì¶ –≠–∫—Å–ø–æ—Ä—Ç ZIP</button>
    </div>
  </div>

  <script type="module">
    import { LayoutUI } from './engine/agents/layout-agent/layout-ui.js';
    LayoutUI.init();

    window.lastGeneratedHTML = "";
    let templates = {};

    async function loadTemplates() {
      try {
        const res = await fetch('./engine/agents/layout-agent/templates/templates.json');
        templates = await res.json();
        const select = document.getElementById("template-select");
        select.innerHTML = '<option value="">üìÇ –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω</option>';
        for (const key in templates) {
          const name = templates[key].name || key;
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = name;
          select.appendChild(opt);
        }
      } catch (err) {
        alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤");
        console.error(err);
      }
    }

    window.handleTemplateBuild = () => {
      const selected = document.getElementById("template-select").value;
      if (!selected || !templates[selected]) return alert("–í—ã–±–µ—Ä–∏ —à–∞–±–ª–æ–Ω!");
      const html = templates[selected].html || "";
      if (!html.trim()) return alert("‚ùó –®–∞–±–ª–æ–Ω –ø—É—Å—Ç!");
      window.lastGeneratedHTML = html;
      LayoutUI.show(html);
    };

    window.loadCustomHTML = () => {
      const file = document.getElementById("upload-html").files[0];
      if (!file) return alert("üì§ –í—ã–±–µ—Ä–∏ .html —Ñ–∞–π–ª!");
      const reader = new FileReader();
      reader.onload = (e) => {
        const html = e.target.result;
        window.lastGeneratedHTML = html;
        LayoutUI.show(html);
      };
      reader.readAsText(file);
    };

    window.generateFromAI = () => {
      const prompt = document.getElementById("ai-description").value.trim();
      if (!prompt) return alert("üß† –í–≤–µ–¥–∏ –æ–ø–∏—Å–∞–Ω–∏–µ!");
      // üîΩ –ü—Ä–∏–º–µ—Ä –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–¥–∫–ª—é—á–∏–º GPT/–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
      const html = `
<section style="padding:20px; text-align:center;">
  <h2>${prompt}</h2>
  <p>–≠—Ç–æ –ø—Ä–∏–º–µ—Ä —Å–µ–∫—Ü–∏–∏, —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é.</p>
  <button style="padding:10px 20px;">–î–µ–π—Å—Ç–≤–∏–µ</button>
</section>
`.trim();
      window.lastGeneratedHTML = html;
      LayoutUI.show(html);
    };

    window.downloadHTML = () => {
      if (!window.lastGeneratedHTML?.trim()) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π HTML!");
      const blob = new Blob([window.lastGeneratedHTML], { type: "text/html" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "webkurier_layout.html";
      link.click();
    };

    window.exportToZip = async () => {
      if (!window.lastGeneratedHTML?.trim()) return alert("–ù–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ!");
      const zip = new JSZip();
      zip.file("index.html", window.lastGeneratedHTML);
      zip.folder("assets"); // –ø—É—Å—Ç–∞—è –ø–∞–ø–∫–∞
      const content = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(content);
      link.download = "webkurier_project.zip";
      link.click();
    };

    await loadTemplates();
  </script>
  <!-- üì¶ –ü–æ–¥–∫–ª—é—á–∞–µ–º JSZip –¥–ª—è ZIP-—Ñ–∞–π–ª–æ–≤ -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</body>
</html>
