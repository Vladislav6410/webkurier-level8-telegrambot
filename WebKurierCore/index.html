// === terminal.js ===
// –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–æ–º–∞–Ω–¥ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å Dropbox-–∞–≥–µ–Ω—Ç–æ–º

// --- –ò–º–ø–æ—Ä—Ç –∞–≥–µ–Ω—Ç–∞ Dropbox ---
import { dropboxAgent } from './engine/dropbox-agent.js';

// --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
let balance = 0;
const autoLoadHistory = true; // –í–∫–ª—é—á–∏—Ç–µ/–≤—ã–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫—É –∏—Å—Ç–æ—Ä–∏–∏

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–ª–∞–Ω—Å–æ–º (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Å–≤–æ–∏) ---
function getBalance() {
  return balance;
}
function setBalance(val) {
  balance = val;
}
function addCoins(n) {
  setBalance(getBalance() + n);
}
function resetCoins() {
  setBalance(0);
}

// --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤—ã–≤–æ–¥–∞ ---
function printToTerminal(message, isHtml = false) {
  const output = document.getElementById('terminal-output');
  if (isHtml) {
    output.value += message + '\n';
  } else {
    output.value += escapeHtml(message) + '\n';
  }
  output.scrollTop = output.scrollHeight;
}
function escapeHtml(text) {
  const div = document.createElement('div');
  div.innerText = text;
  return div.innerHTML;
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ Copilot ---
async function loadCopilotHistory() {
  try {
    const result = await dropboxAgent.load('dropbox-history.json');
    if (!result) {
      printToTerminal('‚ùå –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.');
      return;
    }
    if (typeof result === 'object' && result.text) {
      const text = await result.text();
      printToTerminal(`üìú –ò—Å—Ç–æ—Ä–∏—è Copilot:\n${text}`);
    } else {
      printToTerminal(`üìú –ò—Å—Ç–æ—Ä–∏—è Copilot:\n${result}`);
    }
  } catch (err) {
    printToTerminal(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${err.message || err}`);
  }
}

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ ---
async function handleCommand(event) {
  if (event.key !== 'Enter') return;
  const input = event.target;
  const command = input.value.trim();
  input.value = '';

  if (!command) {
    input.focus();
    return;
  }

  printToTerminal('> ' + command);

  // --- –û—Å–Ω–æ–≤–Ω–æ–π switch –ø–æ –∫–æ–º–∞–Ω–¥–∞–º ---
  switch (true) {
    // –î–æ–±–∞–≤–∏—Ç—å —Å—É–º–º—É –∫ –±–∞–ª–∞–Ω—Å—É: /add 10
    case command.startsWith('/add '): {
      const parts = command.split(' ');
      const amount = parseFloat(parts[1]);
      if (isNaN(amount)) {
        printToTerminal('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å—É–º–º—ã.');
      } else {
        addCoins(amount);
        printToTerminal(`üí∞ –ë–∞–ª–∞–Ω—Å —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ ${amount}. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${getBalance()}.`);
      }
      break;
    }

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ —Ñ–∞–π–ª: /save –∏–º—è.txt
    case command.startsWith('/save'): {
      const parts = command.split(' ');
      const filename = parts[1] || 'webcoin.txt';
      const data = `–ë–∞–ª–∞–Ω—Å: ${getBalance()}`;
      try {
        await dropboxAgent.save(filename, data);
        printToTerminal(`‚úÖ –ë–∞–ª–∞–Ω—Å —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ —Ñ–∞–π–ª "${filename}".`);
      } catch (err) {
        printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message || err}`);
      }
      break;
    }

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª: /load –∏–º—è.txt
    case command.startsWith('/load'): {
      const parts = command.split(' ');
      const filename = parts[1] || 'webcoin.txt';
      try {
        const result = await dropboxAgent.load(filename);
        if (!result) {
          printToTerminal(`‚ùå –§–∞–π–ª "${filename}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
        } else if (typeof result === 'object' && result.text) {
          const text = await result.text();
          printToTerminal(`üì• –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ "${filename}":\n${text}`);
        } else {
          printToTerminal(`üì• –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ "${filename}":\n${result}`);
        }
      } catch (err) {
        printToTerminal(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message || err}`);
      }
      break;
    }

    // –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ Dropbox: /list
    case command === '/list': {
      try {
        const files = await dropboxAgent.list();
        if (!files || !files.length) {
          printToTerminal('üìÇ –ü–∞–ø–∫–∞ Dropbox –ø—É—Å—Ç–∞.');
        } else {
          const fileList = files.map(f => '‚Ä¢ ' + (typeof f === 'string' ? f : f.name)).join('\n');
          printToTerminal(`üìÅ –§–∞–π–ª—ã –≤ Dropbox:\n${fileList}`);
        }
      } catch (err) {
        printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞: ${err.message || err}`);
      }
      break;
    }

    // –ò—Å—Ç–æ—Ä–∏—è Copilot: /history
    case command === '/history': {
      await loadCopilotHistory();
      break;
    }

    // –ë–∞–ª–∞–Ω—Å: /balance
    case command === '/balance': {
      printToTerminal(`üí∞ –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: ${getBalance()}`);
      break;
    }

    // –°–±—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞: /reset
    case command === '/reset': {
      resetCoins();
      printToTerminal('üîÑ –ë–∞–ª–∞–Ω—Å —Å–±—Ä–æ—à–µ–Ω.');
      break;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏: /ping
    case command === '/ping': {
      printToTerminal('üèì Pong!');
      break;
    }

    // –°–ø—Ä–∞–≤–∫–∞: help
    case command === 'help': {
      printToTerminal(
`üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
/add N         ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Å—É–º–º—É –∫ –±–∞–ª–∞–Ω—Å—É
/save [–∏–º—è]    ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å –≤ —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é webcoin.txt)
/load [–∏–º—è]    ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é webcoin.txt)
/list          ‚Äî —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ Dropbox
/history       ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é Copilot
/balance       ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å
/reset         ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –±–∞–ª–∞–Ω—Å
/ping          ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏
help           ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É`
      );
      break;
    }

    // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞
    default: {
      printToTerminal('‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ help –¥–ª—è —Å–ø–∏—Å–∫–∞.');
      break;
    }
  }
  input.focus();
}

// --- –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫ input ---
const terminalInput = document.getElementById('terminal-input');
terminalInput.addEventListener('keydown', handleCommand);

// --- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Dropbox (–µ—Å–ª–∏ –µ—Å—Ç—å –±–ª–æ–∫ –≤ HTML) ---
function addDropboxButtons() {
  const controls = document.getElementById('dropbox-controls');
  if (!controls) return;

  // –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
  if (!document.getElementById('save-btn')) {
    const saveBtn = document.createElement('button');
    saveBtn.id = 'save-btn';
    saveBtn.textContent = 'üì§ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    saveBtn.onclick = async function() {
      const name = prompt('–ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', 'webcoin.txt');
      if (name) {
        const content = `–ë–∞–ª–∞–Ω—Å: ${getBalance()}`;
        try {
          await dropboxAgent.save(name, content);
          printToTerminal(`‚úÖ –§–∞–π–ª "${name}" —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ Dropbox.`);
        } catch (err) {
          printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${err.message || err}`);
        }
      }
      terminalInput.focus();
    };
    controls.appendChild(saveBtn);
  }

  // –ö–Ω–æ–ø–∫–∞ "–ó–∞–≥—Ä—É–∑–∏—Ç—å"
  if (!document.getElementById('load-btn')) {
    const loadBtn = document.createElement('button');
    loadBtn.id = 'load-btn';
    loadBtn.textContent = 'üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å';
    loadBtn.onclick = async function() {
      const name = prompt('–ò–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:', 'webcoin.txt');
      if (name) {
        try {
          const result = await dropboxAgent.load(name);
          if (result && result.text) {
            const text = await result.text();
            printToTerminal(`üì• –§–∞–π–ª "${name}" –∑–∞–≥—Ä—É–∂–µ–Ω:\n${text}`);
          } else if (result) {
            printToTerminal(`üì• –§–∞–π–ª "${name}" –∑–∞–≥—Ä—É–∂–µ–Ω:\n${result}`);
          } else {
            printToTerminal(`‚ùå –§–∞–π–ª "${name}" –Ω–µ –Ω–∞–π–¥–µ–Ω.`);
          }
        } catch (err) {
          printToTerminal(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${err.message || err}`);
        }
      }
      terminalInput.focus();
    };
    controls.appendChild(loadBtn);
  }

  // –ö–Ω–æ–ø–∫–∞ "–§–∞–π–ª—ã"
  if (!document.getElementById('list-btn')) {
    const listBtn = document.createElement('button');
    listBtn.id = 'list-btn';
    listBtn.textContent = 'üìÅ –§–∞–π–ª—ã';
    listBtn.onclick = async function() {
      try {
        const files = await dropboxAgent.list();
        if (!files || !files.length) {
          printToTerminal('üìÇ –ü–∞–ø–∫–∞ Dropbox –ø—É—Å—Ç–∞.');
        } else {
          const fileList = files.map(f => '‚Ä¢ ' + (typeof f === 'string' ? f : f.name)).join('\n');
          printToTerminal(`üìÅ –§–∞–π–ª—ã –≤ Dropbox:\n${fileList}`);
        }
      } catch (err) {
        printToTerminal(`‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞: ${err.message || err}`);
      }
      terminalInput.focus();
    };
    controls.appendChild(listBtn);
  }

  // –ö–Ω–æ–ø–∫–∞ "–ò—Å—Ç–æ—Ä–∏—è Copilot"
  if (!document.getElementById('copilot-history-btn')) {
    const btn = document.createElement('button');
    btn.id = 'copilot-history-btn';
    btn.textContent = 'üìú –ò—Å—Ç–æ—Ä–∏—è Copilot';
    btn.onclick = loadCopilotHistory;
    controls.appendChild(btn);
  }
}
addDropboxButtons();

// --- –ê–≤—Ç–æ–∑–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ ---
if (autoLoadHistory) {
  loadCopilotHistory();
}

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
printToTerminal('üñ•Ô∏è –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–µ—Ä–º–∏–Ω–∞–ª –≥–æ—Ç–æ–≤. –í–≤–µ–¥–∏—Ç–µ help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.');
terminalInput.focus();
